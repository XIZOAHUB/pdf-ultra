<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#00d4ff">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="PDFUltra">
<meta name="description" content="Convert PDF to anything. Anything to PDF. The world's most powerful free PDF converter.">
<title>PDF Ultra Converter</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;900&family=IBM+Plex+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #050810;
    --bg2: #0a0f1e;
    --bg3: #0d1525;
    --card: #0d1525;
    --border: rgba(0, 212, 255, 0.15);
    --primary: #00d4ff;
    --primary-dim: rgba(0, 212, 255, 0.15);
    --secondary: #ff3366;
    --accent: #7c3aed;
    --success: #00ff88;
    --warn: #ffaa00;
    --text: #e2e8f0;
    --text-dim: #64748b;
    --text-muted: #334155;
    --glow: 0 0 20px rgba(0, 212, 255, 0.4);
    --glow-strong: 0 0 40px rgba(0, 212, 255, 0.6), 0 0 80px rgba(0, 212, 255, 0.2);
    --radius: 12px;
    --radius-lg: 20px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  html { scroll-behavior: smooth; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'IBM Plex Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Animated background grid */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    z-index: 0;
    pointer-events: none;
  }

  body::after {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 20% 20%, rgba(0,212,255,0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(124,58,237,0.04) 0%, transparent 50%);
    animation: bgPulse 8s ease-in-out infinite alternate;
    z-index: 0;
    pointer-events: none;
  }

  @keyframes bgPulse {
    0% { transform: translate(0, 0); }
    100% { transform: translate(2%, 2%); }
  }

  /* INSTALL BANNER */
  #install-banner {
    display: none;
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    background: linear-gradient(135deg, #0d1525, #0a0f1e);
    border: 1px solid var(--primary);
    border-radius: 16px;
    padding: 16px 24px;
    box-shadow: var(--glow-strong), 0 20px 60px rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    gap: 16px;
    max-width: 480px;
    width: calc(100% - 48px);
    animation: slideUp 0.4s cubic-bezier(0.34,1.56,0.64,1);
  }

  #install-banner.show { display: flex; }

  @keyframes slideUp {
    from { transform: translateX(-50%) translateY(100px); opacity: 0; }
    to { transform: translateX(-50%) translateY(0); opacity: 1; }
  }

  .install-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 22px;
  }

  .install-text { flex: 1; }
  .install-text strong { display: block; font-family: 'Orbitron', monospace; font-size: 13px; color: var(--primary); }
  .install-text span { font-size: 12px; color: var(--text-dim); }

  .install-btns { display: flex; gap: 8px; }

  #btn-install {
    background: linear-gradient(135deg, var(--primary), #0088ff);
    color: #050810;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-family: 'Orbitron', monospace;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  #btn-install:hover { transform: scale(1.05); box-shadow: var(--glow); }

  #btn-dismiss {
    background: transparent;
    color: var(--text-dim);
    border: 1px solid var(--text-muted);
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.2s;
  }

  #btn-dismiss:hover { border-color: var(--secondary); color: var(--secondary); }

  /* HEADER */
  header {
    position: relative;
    z-index: 10;
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(20px);
    background: rgba(5,8,16,0.8);
    position: sticky;
    top: 0;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
  }

  .logo-icon {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Orbitron', monospace;
    font-weight: 900;
    font-size: 16px;
    color: #050810;
    box-shadow: var(--glow);
  }

  .logo-text {
    font-family: 'Orbitron', monospace;
    font-size: 18px;
    font-weight: 700;
    background: linear-gradient(90deg, var(--primary), #7c3aed);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 2px;
  }

  .logo-sub {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 9px;
    color: var(--text-dim);
    letter-spacing: 3px;
    text-transform: uppercase;
  }

  .header-stats {
    display: flex;
    gap: 24px;
    align-items: center;
  }

  .stat-pill {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    background: var(--bg2);
    border: 1px solid var(--border);
    padding: 6px 14px;
    border-radius: 20px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .stat-pill .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--success);
    box-shadow: 0 0 6px var(--success);
    animation: blink 2s ease infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* HERO */
  .hero {
    position: relative;
    z-index: 1;
    text-align: center;
    padding: 60px 32px 40px;
  }

  .hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,212,255,0.08);
    border: 1px solid rgba(0,212,255,0.3);
    border-radius: 20px;
    padding: 6px 16px;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    color: var(--primary);
    letter-spacing: 2px;
    margin-bottom: 20px;
  }

  h1 {
    font-family: 'Orbitron', monospace;
    font-size: clamp(28px, 6vw, 56px);
    font-weight: 900;
    line-height: 1.1;
    letter-spacing: -1px;
    margin-bottom: 16px;
    background: linear-gradient(135deg, #ffffff 0%, var(--primary) 50%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .hero-sub {
    font-size: 16px;
    color: var(--text-dim);
    max-width: 560px;
    margin: 0 auto 32px;
    line-height: 1.6;
  }

  .conversion-count {
    font-family: 'Orbitron', monospace;
    font-size: 40px;
    font-weight: 900;
    color: var(--primary);
    text-shadow: var(--glow);
    display: inline-block;
    animation: countUp 0.5s ease-out;
  }

  @keyframes countUp {
    from { transform: scale(0.5); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  /* MAIN LAYOUT */
  .app-layout {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 0;
    min-height: calc(100vh - 200px);
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 24px 40px;
  }

  /* SIDEBAR */
  .sidebar {
    padding: 24px 0 24px 0;
    border-right: 1px solid var(--border);
    padding-right: 24px;
  }

  .sidebar-title {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 12px;
    padding-left: 4px;
  }

  .cat-group { margin-bottom: 24px; }

  .cat-btn {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    border-radius: var(--radius);
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-dim);
    cursor: pointer;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s;
    text-align: left;
    position: relative;
    overflow: hidden;
  }

  .cat-btn::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: 2px;
    background: var(--primary);
    transform: scaleY(0);
    transition: transform 0.2s;
  }

  .cat-btn:hover { background: var(--primary-dim); color: var(--text); border-color: var(--border); }
  .cat-btn:hover::before { transform: scaleY(1); }

  .cat-btn.active {
    background: var(--primary-dim);
    color: var(--primary);
    border-color: rgba(0,212,255,0.3);
    font-weight: 600;
  }

  .cat-btn.active::before { transform: scaleY(1); }

  .cat-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
    background: rgba(255,255,255,0.04);
  }

  .cat-btn.active .cat-icon { background: rgba(0,212,255,0.15); }

  .cat-label { flex: 1; }
  .cat-count {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 10px;
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 2px 7px;
    color: var(--text-muted);
  }
  .cat-btn.active .cat-count { background: rgba(0,212,255,0.1); border-color: rgba(0,212,255,0.3); color: var(--primary); }

  /* MAIN CONTENT */
  .main-content {
    padding: 24px 0 24px 32px;
  }

  /* UPLOAD ZONE */
  .upload-zone {
    border: 2px dashed rgba(0,212,255,0.3);
    border-radius: var(--radius-lg);
    padding: 48px 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: rgba(0,212,255,0.02);
    position: relative;
    overflow: hidden;
    margin-bottom: 32px;
  }

  .upload-zone::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, rgba(0,212,255,0.05), transparent, rgba(124,58,237,0.05));
    opacity: 0;
    transition: opacity 0.3s;
  }

  .upload-zone:hover, .upload-zone.drag-over {
    border-color: var(--primary);
    background: rgba(0,212,255,0.05);
    box-shadow: var(--glow);
  }

  .upload-zone:hover::before, .upload-zone.drag-over::before { opacity: 1; }

  .upload-zone.drag-over { transform: scale(1.01); }

  .upload-icon {
    font-size: 56px;
    margin-bottom: 16px;
    display: block;
    filter: drop-shadow(0 0 16px rgba(0,212,255,0.4));
  }

  .upload-title {
    font-family: 'Orbitron', monospace;
    font-size: 20px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 8px;
  }

  .upload-sub { font-size: 14px; color: var(--text-dim); margin-bottom: 20px; }

  .upload-formats {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 6px;
    margin-bottom: 20px;
  }

  .fmt-tag {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 10px;
    padding: 4px 10px;
    border-radius: 6px;
    background: var(--bg3);
    border: 1px solid var(--border);
    color: var(--text-dim);
    letter-spacing: 1px;
  }

  .btn-upload {
    background: linear-gradient(135deg, var(--primary), #0088ff);
    color: #050810;
    border: none;
    padding: 14px 36px;
    border-radius: 10px;
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 20px rgba(0,212,255,0.3);
  }

  .btn-upload:hover { transform: translateY(-2px); box-shadow: var(--glow-strong); }

  #file-input { display: none; }

  /* CONVERSION GRID */
  .section-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .section-title {
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 1px;
  }

  .section-title span { color: var(--primary); }

  .conv-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
    margin-bottom: 32px;
  }

  .conv-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    text-align: center;
  }

  .conv-card::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(135deg, var(--primary-dim), transparent);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .conv-card:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--glow);
  }

  .conv-card:hover::before { opacity: 1; }

  .conv-card.selected {
    border-color: var(--primary);
    background: rgba(0,212,255,0.08);
    box-shadow: var(--glow);
  }

  .conv-card.selected::before { opacity: 1; }

  .conv-from {
    font-size: 22px;
    margin-bottom: 4px;
  }

  .conv-arrow {
    font-size: 12px;
    color: var(--primary);
    margin: 4px 0;
  }

  .conv-to {
    font-family: 'Orbitron', monospace;
    font-size: 13px;
    font-weight: 700;
    color: var(--primary);
    letter-spacing: 1px;
  }

  .conv-desc {
    font-size: 11px;
    color: var(--text-muted);
    margin-top: 4px;
    line-height: 1.4;
  }

  /* FILE INFO BAR */
  #file-info-bar {
    display: none;
    background: var(--bg2);
    border: 1px solid rgba(0,255,136,0.3);
    border-radius: var(--radius);
    padding: 16px 20px;
    margin-bottom: 24px;
    align-items: center;
    gap: 16px;
    animation: fadeIn 0.3s ease;
  }

  #file-info-bar.show { display: flex; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .file-icon-wrap {
    width: 48px;
    height: 48px;
    background: rgba(0,255,136,0.1);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
  }

  .file-details { flex: 1; }
  .file-name { font-weight: 600; font-size: 14px; color: var(--text); margin-bottom: 3px; }
  .file-meta { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--text-dim); }

  .file-actions { display: flex; gap: 8px; }

  .btn-clear {
    background: transparent;
    border: 1px solid rgba(255,51,102,0.4);
    color: var(--secondary);
    padding: 8px 16px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s;
  }

  .btn-clear:hover { background: rgba(255,51,102,0.1); border-color: var(--secondary); }

  /* CONVERSION PANEL */
  #conversion-panel {
    display: none;
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 24px;
    margin-bottom: 24px;
    animation: fadeIn 0.3s ease;
  }

  #conversion-panel.show { display: block; }

  .panel-title {
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .panel-title-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .panel-options {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 12px;
    margin-bottom: 20px;
  }

  .option-group { display: flex; flex-direction: column; gap: 6px; }
  .option-label {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 1px;
    text-transform: uppercase;
  }

  .option-select {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    padding: 10px 14px;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 13px;
    outline: none;
    cursor: pointer;
    transition: border-color 0.2s;
  }

  .option-select:focus { border-color: var(--primary); }

  .option-input {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    padding: 10px 14px;
    font-family: 'IBM Plex Sans', sans-serif;
    font-size: 13px;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  .option-input:focus { border-color: var(--primary); }

  .btn-convert {
    width: 100%;
    background: linear-gradient(135deg, var(--primary), #0088ff, var(--accent));
    background-size: 200% auto;
    color: #fff;
    border: none;
    padding: 16px 32px;
    border-radius: 12px;
    font-family: 'Orbitron', monospace;
    font-size: 14px;
    font-weight: 700;
    letter-spacing: 2px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 20px rgba(0,212,255,0.3);
    position: relative;
    overflow: hidden;
  }

  .btn-convert::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.4s, height 0.4s;
  }

  .btn-convert:hover::before { width: 300px; height: 300px; }
  .btn-convert:hover { background-position: right center; transform: translateY(-2px); box-shadow: var(--glow-strong); }
  .btn-convert:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  /* PROGRESS */
  #progress-wrap {
    display: none;
    margin-top: 16px;
  }

  #progress-wrap.show { display: block; }

  .progress-bar-outer {
    background: var(--bg3);
    border-radius: 20px;
    height: 8px;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .progress-bar-inner {
    height: 100%;
    border-radius: 20px;
    background: linear-gradient(90deg, var(--primary), var(--accent));
    transition: width 0.3s ease;
    box-shadow: 0 0 10px var(--primary);
    width: 0%;
  }

  .progress-text {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 12px;
    color: var(--text-dim);
    text-align: center;
  }

  /* RESULT */
  #result-area {
    display: none;
    animation: fadeIn 0.4s ease;
  }

  #result-area.show { display: block; }

  .result-card {
    background: rgba(0,255,136,0.05);
    border: 1px solid rgba(0,255,136,0.3);
    border-radius: var(--radius-lg);
    padding: 28px;
    text-align: center;
  }

  .result-icon { font-size: 56px; margin-bottom: 16px; }

  .result-title {
    font-family: 'Orbitron', monospace;
    font-size: 20px;
    font-weight: 700;
    color: var(--success);
    margin-bottom: 8px;
  }

  .result-sub { font-size: 14px; color: var(--text-dim); margin-bottom: 24px; }

  .result-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }

  .btn-download {
    background: linear-gradient(135deg, var(--success), #00aa55);
    color: #050810;
    border: none;
    padding: 14px 32px;
    border-radius: 10px;
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
    box-shadow: 0 4px 20px rgba(0,255,136,0.3);
  }

  .btn-download:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,255,136,0.5); }

  .btn-another {
    background: transparent;
    color: var(--primary);
    border: 1px solid rgba(0,212,255,0.4);
    padding: 14px 24px;
    border-radius: 10px;
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-another:hover { background: var(--primary-dim); border-color: var(--primary); }

  /* FEATURES STRIP */
  .features-strip {
    position: relative;
    z-index: 1;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    max-width: 1400px;
    margin: 0 auto 40px;
    padding: 0 24px;
  }

  .feat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    transition: all 0.2s;
  }

  .feat-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--glow); }

  .feat-icon { font-size: 28px; margin-bottom: 10px; }

  .feat-title {
    font-family: 'Orbitron', monospace;
    font-size: 12px;
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 6px;
    letter-spacing: 1px;
  }

  .feat-desc { font-size: 12px; color: var(--text-dim); line-height: 1.5; }

  /* FOOTER */
  footer {
    position: relative;
    z-index: 1;
    border-top: 1px solid var(--border);
    padding: 24px 32px;
    text-align: center;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 11px;
    color: var(--text-muted);
    letter-spacing: 1px;
  }

  footer a { color: var(--primary); text-decoration: none; }

  /* PAGE VIEW TRANSITIONS */
  .page { display: none; }
  .page.active { display: block; }

  /* TOAST */
  #toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 20px;
    font-size: 13px;
    color: var(--text);
    opacity: 0;
    transition: all 0.3s;
    z-index: 999;
    pointer-events: none;
    white-space: nowrap;
  }

  #toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .app-layout {
      grid-template-columns: 1fr;
      padding: 0 16px 40px;
    }

    .sidebar {
      border-right: none;
      border-bottom: 1px solid var(--border);
      padding-right: 0;
      padding-bottom: 16px;
    }

    .cat-group { display: flex; flex-wrap: wrap; gap: 8px; }
    .sidebar-title { display: none; }
    .cat-btn { width: auto; padding: 8px 12px; }
    .cat-count { display: none; }

    .main-content { padding: 20px 0 0; }

    header { padding: 16px; }
    .header-stats { display: none; }
    .logo-text { font-size: 14px; }

    h1 { font-size: 28px; }
    .hero { padding: 32px 16px 24px; }

    .features-strip { grid-template-columns: repeat(2, 1fr); padding: 0 16px; }
  }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--bg3); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

  /* Page load animations */
  .fade-in { animation: fadeIn 0.6s ease both; }
  .fade-in-delay-1 { animation: fadeIn 0.6s ease 0.1s both; }
  .fade-in-delay-2 { animation: fadeIn 0.6s ease 0.2s both; }
  .fade-in-delay-3 { animation: fadeIn 0.6s ease 0.3s both; }

  .shimmer {
    background: linear-gradient(90deg, var(--bg3) 25%, rgba(0,212,255,0.05) 50%, var(--bg3) 75%);
    background-size: 200% auto;
    animation: shimmer 2s linear infinite;
  }

  @keyframes shimmer {
    from { background-position: 200% center; }
    to { background-position: -200% center; }
  }
</style>
</head>
<body>

<!-- INSTALL BANNER -->
<div id="install-banner">
  <div class="install-icon">‚ö°</div>
  <div class="install-text">
    <strong>INSTALL PDF ULTRA</strong>
    <span>Works offline ¬∑ No ads ¬∑ Free forever</span>
  </div>
  <div class="install-btns">
    <button id="btn-install">INSTALL APP</button>
    <button id="btn-dismiss">‚úï</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- HEADER -->
<header class="fade-in">
  <div class="logo">
    <div class="logo-icon">P</div>
    <div>
      <div class="logo-text">PDF ULTRA</div>
      <div class="logo-sub">All Converter</div>
    </div>
  </div>
  <div class="header-stats">
    <div class="stat-pill"><span class="dot"></span> Online ¬∑ Free ¬∑ No Signup</div>
    <div class="stat-pill">‚ö° 20+ Formats</div>
    <div class="stat-pill">üîí 100% Private</div>
  </div>
</header>

<!-- HERO -->
<div class="hero fade-in-delay-1">
  <div class="hero-badge">‚ú¶ THE WORLD'S MOST POWERFUL PDF TOOLKIT ‚ú¶</div>
  <h1>Convert PDF<br>To Anything.</h1>
  <p class="hero-sub">One tool to rule them all. PDF ‚Üî Word, Excel, PowerPoint, Images, TXT, HTML, Markdown, CSV & more. All in your browser. All free. All private.</p>
</div>

<!-- APP LAYOUT -->
<div class="app-layout fade-in-delay-2">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="cat-group">
      <div class="sidebar-title">PDF Output</div>
      <button class="cat-btn active" data-cat="pdf-to" onclick="switchCat(this, 'pdf-to')">
        <span class="cat-icon">üìÑ</span>
        <span class="cat-label">PDF ‚Üí Anything</span>
        <span class="cat-count">11</span>
      </button>
    </div>
    <div class="cat-group">
      <div class="sidebar-title">Create PDF</div>
      <button class="cat-btn" data-cat="to-pdf" onclick="switchCat(this, 'to-pdf')">
        <span class="cat-icon">üîÑ</span>
        <span class="cat-label">Anything ‚Üí PDF</span>
        <span class="cat-count">7</span>
      </button>
    </div>
    <div class="cat-group">
      <div class="sidebar-title">PDF Tools</div>
      <button class="cat-btn" data-cat="tools" onclick="switchCat(this, 'tools')">
        <span class="cat-icon">üõ†Ô∏è</span>
        <span class="cat-label">PDF Tools</span>
        <span class="cat-count">5</span>
      </button>
    </div>
    <div class="cat-group">
      <div class="sidebar-title">About</div>
      <button class="cat-btn" data-cat="about" onclick="switchCat(this, 'about')">
        <span class="cat-icon">‚ÑπÔ∏è</span>
        <span class="cat-label">How It Works</span>
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">

    <!-- FILE INPUT -->
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
      <span class="upload-icon">üìÇ</span>
      <div class="upload-title">Drop your file here</div>
      <p class="upload-sub">Or click to browse from your device</p>
      <div class="upload-formats" id="upload-formats">
        <span class="fmt-tag">PDF</span>
        <span class="fmt-tag">DOCX</span>
        <span class="fmt-tag">XLSX</span>
        <span class="fmt-tag">PPTX</span>
        <span class="fmt-tag">JPG</span>
        <span class="fmt-tag">PNG</span>
        <span class="fmt-tag">TXT</span>
        <span class="fmt-tag">HTML</span>
        <span class="fmt-tag">MD</span>
        <span class="fmt-tag">CSV</span>
      </div>
      <button class="btn-upload" onclick="event.stopPropagation(); document.getElementById('file-input').click()">
        ‚ö° CHOOSE FILE
      </button>
    </div>
    <input type="file" id="file-input" accept="*/*" onchange="handleFile(this.files[0])">

    <!-- FILE INFO BAR -->
    <div id="file-info-bar">
      <div class="file-icon-wrap" id="file-icon">üìÑ</div>
      <div class="file-details">
        <div class="file-name" id="file-name-display">filename.pdf</div>
        <div class="file-meta" id="file-meta-display">0 KB ¬∑ PDF Document</div>
      </div>
      <div class="file-actions">
        <button class="btn-clear" onclick="clearFile()">‚úï Clear</button>
      </div>
    </div>

    <!-- CONVERSION CARDS -->
    <div id="cat-pdf-to" class="cat-page">
      <div class="section-head">
        <div class="section-title">Convert <span>PDF</span> to ‚Üí</div>
      </div>
      <div class="conv-grid">
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-docx')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">WORD</div>
          <div class="conv-desc">Extract text into .docx format</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-xlsx')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">EXCEL</div>
          <div class="conv-desc">Extract data into spreadsheet</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-pptx')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">PPT</div>
          <div class="conv-desc">Convert slides to presentation</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-jpg')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">JPG</div>
          <div class="conv-desc">Each page as JPEG image</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-png')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">PNG</div>
          <div class="conv-desc">Each page as PNG image</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-txt')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">TXT</div>
          <div class="conv-desc">Plain text extraction</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-html')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">HTML</div>
          <div class="conv-desc">Web-ready HTML page</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-md')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">MARKDOWN</div>
          <div class="conv-desc">Formatted .md document</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-csv')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">CSV</div>
          <div class="conv-desc">Spreadsheet / table data</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-epub')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">EPUB</div>
          <div class="conv-desc">eBook format</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-to-rtf')">
          <div class="conv-from">üìÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">RTF</div>
          <div class="conv-desc">Rich Text Format</div>
        </div>
      </div>
    </div>

    <div id="cat-to-pdf" class="cat-page" style="display:none">
      <div class="section-head">
        <div class="section-title">Convert ‚Üí <span>PDF</span></div>
      </div>
      <div class="conv-grid">
        <div class="conv-card" onclick="selectConversion(this, 'img-to-pdf')">
          <div class="conv-from">üñºÔ∏è</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">PDF</div>
          <div class="conv-desc">JPG/PNG/WebP ‚Üí PDF</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'txt-to-pdf')">
          <div class="conv-from">üìù</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">PDF</div>
          <div class="conv-desc">Text file ‚Üí PDF</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'html-to-pdf')">
          <div class="conv-from">üåê</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">PDF</div>
          <div class="conv-desc">HTML page ‚Üí PDF</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'md-to-pdf')">
          <div class="conv-from">üìã</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">PDF</div>
          <div class="conv-desc">Markdown ‚Üí PDF</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'csv-to-pdf')">
          <div class="conv-from">üìä</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">PDF</div>
          <div class="conv-desc">CSV table ‚Üí PDF</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'xlsx-to-pdf')">
          <div class="conv-from">üìó</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">PDF</div>
          <div class="conv-desc">Excel spreadsheet ‚Üí PDF</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'rtf-to-pdf')">
          <div class="conv-from">üìÉ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">PDF</div>
          <div class="conv-desc">RTF document ‚Üí PDF</div>
        </div>
      </div>
    </div>

    <div id="cat-tools" class="cat-page" style="display:none">
      <div class="section-head">
        <div class="section-title">PDF <span>Tools</span></div>
      </div>
      <div class="conv-grid">
        <div class="conv-card" onclick="selectConversion(this, 'pdf-merge')">
          <div class="conv-from">üîó</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">MERGE</div>
          <div class="conv-desc">Combine multiple PDFs</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-split')">
          <div class="conv-from">‚úÇÔ∏è</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">SPLIT</div>
          <div class="conv-desc">Split PDF into pages</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-rotate')">
          <div class="conv-from">üîÑ</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">ROTATE</div>
          <div class="conv-desc">Rotate PDF pages</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-watermark')">
          <div class="conv-from">üíß</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">WATERMARK</div>
          <div class="conv-desc">Add text watermark</div>
        </div>
        <div class="conv-card" onclick="selectConversion(this, 'pdf-compress')">
          <div class="conv-from">üóúÔ∏è</div>
          <div class="conv-arrow">‚Üì</div>
          <div class="conv-to">COMPRESS</div>
          <div class="conv-desc">Reduce file size</div>
        </div>
      </div>
    </div>

    <div id="cat-about" class="cat-page" style="display:none">
      <div style="background:var(--bg2); border:1px solid var(--border); border-radius:var(--radius-lg); padding:32px;">
        <h2 style="font-family:'Orbitron',monospace; font-size:18px; color:var(--primary); margin-bottom:16px;">üîí 100% Private ‚Äî Runs In Your Browser</h2>
        <p style="color:var(--text-dim); line-height:1.8; font-size:14px; margin-bottom:16px;">
          PDF Ultra is a fully client-side application. Your files <strong style="color:var(--text)">never leave your device</strong>. All conversions happen right here in your browser using cutting-edge WebAssembly and JavaScript libraries.
        </p>
        <p style="color:var(--text-dim); line-height:1.8; font-size:14px; margin-bottom:24px;">
          No uploads to servers. No account needed. No data collection. Just pure, powerful PDF conversion.
        </p>

        <h3 style="font-family:'Orbitron',monospace; font-size:13px; color:var(--text); margin-bottom:12px; letter-spacing:1px;">POWERED BY</h3>
        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap:10px;">
          <div style="background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:12px; font-size:12px; color:var(--text-dim);">
            <strong style="color:var(--primary); font-family:'IBM Plex Mono',monospace;">PDF.js</strong> by Mozilla<br>PDF rendering engine
          </div>
          <div style="background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:12px; font-size:12px; color:var(--text-dim);">
            <strong style="color:var(--primary); font-family:'IBM Plex Mono',monospace;">pdf-lib</strong><br>PDF creation & editing
          </div>
          <div style="background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:12px; font-size:12px; color:var(--text-dim);">
            <strong style="color:var(--primary); font-family:'IBM Plex Mono',monospace;">jsPDF</strong><br>PDF generation
          </div>
          <div style="background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:12px; font-size:12px; color:var(--text-dim);">
            <strong style="color:var(--primary); font-family:'IBM Plex Mono',monospace;">SheetJS</strong><br>Excel/CSV parsing
          </div>
          <div style="background:var(--bg3); border:1px solid var(--border); border-radius:8px; padding:12px; font-size:12px; color:var(--text-dim);">
            <strong style="color:var(--primary); font-family:'IBM Plex Mono',monospace;">JSZip</strong><br>ZIP compression
          </div>
        </div>

        <div style="margin-top:24px; background:rgba(0,212,255,0.05); border:1px solid rgba(0,212,255,0.2); border-radius:10px; padding:16px;">
          <strong style="font-family:'Orbitron',monospace; font-size:12px; color:var(--primary); letter-spacing:1px;">INSTALL AS APP</strong>
          <p style="font-size:13px; color:var(--text-dim); margin-top:8px; line-height:1.6;">
            PDF Ultra is a Progressive Web App (PWA). Click the install button at the bottom of the page to add it to your home screen / desktop. Works completely offline after install.
          </p>
        </div>
      </div>
    </div>

    <!-- CONVERSION PANEL -->
    <div id="conversion-panel">
      <div class="panel-title">
        <div class="panel-title-icon" id="panel-icon">‚ö°</div>
        <span id="panel-title-text">Configure Conversion</span>
      </div>
      <div class="panel-options" id="panel-options"></div>
      <button class="btn-convert" id="btn-convert" onclick="doConvert()">‚ö° CONVERT NOW</button>
      <div id="progress-wrap">
        <div class="progress-bar-outer">
          <div class="progress-bar-inner" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text">Processing...</div>
      </div>
    </div>

    <!-- RESULT AREA -->
    <div id="result-area">
      <div class="result-card">
        <div class="result-icon">‚úÖ</div>
        <div class="result-title">CONVERSION COMPLETE!</div>
        <div class="result-sub" id="result-sub">Your file is ready to download.</div>
        <div class="result-actions">
          <button class="btn-download" id="btn-download" onclick="triggerDownload()">‚¨á DOWNLOAD FILE</button>
          <button class="btn-another" onclick="resetAll()">‚Ü∫ CONVERT ANOTHER</button>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- FEATURES STRIP -->
<div class="features-strip fade-in-delay-3">
  <div class="feat-card">
    <div class="feat-icon">‚ö°</div>
    <div class="feat-title">BLAZING FAST</div>
    <div class="feat-desc">Client-side processing. No upload wait times. Instant results.</div>
  </div>
  <div class="feat-card">
    <div class="feat-icon">üîí</div>
    <div class="feat-title">100% PRIVATE</div>
    <div class="feat-desc">Files never leave your device. Zero server uploads. Zero tracking.</div>
  </div>
  <div class="feat-card">
    <div class="feat-icon">üì≤</div>
    <div class="feat-title">INSTALLABLE</div>
    <div class="feat-desc">Install as a native app. Works offline. Lives in your gallery.</div>
  </div>
  <div class="feat-card">
    <div class="feat-icon">üÜì</div>
    <div class="feat-title">FREE FOREVER</div>
    <div class="feat-desc">No subscriptions. No watermarks. No limits. Completely free.</div>
  </div>
  <div class="feat-card">
    <div class="feat-icon">üåê</div>
    <div class="feat-title">20+ FORMATS</div>
    <div class="feat-desc">Word, Excel, PPT, Images, TXT, HTML, Markdown, CSV and more.</div>
  </div>
</div>

<!-- FOOTER -->
<footer>
  <span>PDF ULTRA CONVERTER ¬∑ Made with ‚ö° ¬∑ Open Source on <a href="https://github.com" target="_blank">GitHub</a> ¬∑ No Ads ¬∑ No Tracking ¬∑ Free Forever</span>
</footer>

<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<script>
// ===== SERVICE WORKER REGISTRATION =====
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.log('SW registration failed:', err));
  });
}

// ===== PDF.js SETUP =====
let pdfjsLib = window['pdfjs-dist/build/pdf'];
if (pdfjsLib) pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ===== PWA INSTALL =====
let deferredPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const banner = document.getElementById('install-banner');
  banner.classList.add('show');
  setTimeout(() => banner.classList.add('show'), 1000);
});

document.getElementById('btn-install').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  if (outcome === 'accepted') {
    showToast('üéâ PDF Ultra installed successfully!');
    document.getElementById('install-banner').classList.remove('show');
  }
  deferredPrompt = null;
});

document.getElementById('btn-dismiss').addEventListener('click', () => {
  document.getElementById('install-banner').classList.remove('show');
});

window.addEventListener('appinstalled', () => {
  showToast('‚úÖ App installed! Check your home screen.');
  document.getElementById('install-banner').classList.remove('show');
});

// ===== APP STATE =====
let currentFile = null;
let currentConversion = null;
let resultBlob = null;
let resultFilename = '';

// ===== FILE HANDLING =====
const FILE_ICONS = {
  pdf: 'üìÑ', doc: 'üìù', docx: 'üìù', xls: 'üìä', xlsx: 'üìä',
  ppt: 'üìë', pptx: 'üìë', jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', png: 'üñºÔ∏è',
  gif: 'üñºÔ∏è', webp: 'üñºÔ∏è', txt: 'üìÉ', html: 'üåê', htm: 'üåê',
  md: 'üìã', csv: 'üìä', rtf: 'üìÉ', epub: 'üìö', default: 'üìÅ'
};

function handleDragOver(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.add('drag-over');
}

function handleDragLeave(e) {
  document.getElementById('upload-zone').classList.remove('drag-over');
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) handleFile(file);
}

function handleFile(file) {
  if (!file) return;
  currentFile = file;
  const ext = file.name.split('.').pop().toLowerCase();
  const icon = FILE_ICONS[ext] || FILE_ICONS.default;
  const size = formatFileSize(file.size);

  document.getElementById('file-icon').textContent = icon;
  document.getElementById('file-name-display').textContent = file.name;
  document.getElementById('file-meta-display').textContent = `${size} ¬∑ ${ext.toUpperCase()} File`;

  const bar = document.getElementById('file-info-bar');
  bar.classList.add('show');

  // Auto-suggest category based on file type
  if (ext === 'pdf') {
    // Stay on pdf-to
  } else {
    // Switch to to-pdf
    const toBtn = document.querySelector('[data-cat="to-pdf"]');
    if (toBtn) switchCat(toBtn, 'to-pdf');
  }

  showToast(`üìÇ File loaded: ${file.name}`);
  hideResult();
}

function formatFileSize(bytes) {
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
  return (bytes/1048576).toFixed(1) + ' MB';
}

function clearFile() {
  currentFile = null;
  document.getElementById('file-input').value = '';
  document.getElementById('file-info-bar').classList.remove('show');
  document.getElementById('conversion-panel').classList.remove('show');
  hideResult();
  document.querySelectorAll('.conv-card.selected').forEach(c => c.classList.remove('selected'));
  currentConversion = null;
  showToast('File cleared.');
}

// ===== CATEGORY SWITCHING =====
function switchCat(btn, cat) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  document.querySelectorAll('.cat-page').forEach(p => p.style.display = 'none');
  const page = document.getElementById('cat-' + cat);
  if (page) page.style.display = 'block';

  document.getElementById('conversion-panel').classList.remove('show');
  document.querySelectorAll('.conv-card.selected').forEach(c => c.classList.remove('selected'));
  hideResult();
}

// ===== CONVERSION SELECTION =====
const CONVERSION_META = {
  'pdf-to-docx': { title: 'PDF ‚Üí Word Document', icon: 'üìù', accept: '.pdf', outputExt: 'docx', outputMime: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' },
  'pdf-to-xlsx': { title: 'PDF ‚Üí Excel Spreadsheet', icon: 'üìä', accept: '.pdf', outputExt: 'xlsx', outputMime: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' },
  'pdf-to-pptx': { title: 'PDF ‚Üí PowerPoint', icon: 'üìë', accept: '.pdf', outputExt: 'pptx', outputMime: 'application/vnd.openxmlformats-officedocument.presentationml.presentation' },
  'pdf-to-jpg': { title: 'PDF ‚Üí JPEG Images', icon: 'üñºÔ∏è', accept: '.pdf', outputExt: 'zip', outputMime: 'application/zip' },
  'pdf-to-png': { title: 'PDF ‚Üí PNG Images', icon: 'üñºÔ∏è', accept: '.pdf', outputExt: 'zip', outputMime: 'application/zip' },
  'pdf-to-txt': { title: 'PDF ‚Üí Plain Text', icon: 'üìÉ', accept: '.pdf', outputExt: 'txt', outputMime: 'text/plain' },
  'pdf-to-html': { title: 'PDF ‚Üí HTML Page', icon: 'üåê', accept: '.pdf', outputExt: 'html', outputMime: 'text/html' },
  'pdf-to-md': { title: 'PDF ‚Üí Markdown', icon: 'üìã', accept: '.pdf', outputExt: 'md', outputMime: 'text/markdown' },
  'pdf-to-csv': { title: 'PDF ‚Üí CSV Spreadsheet', icon: 'üìä', accept: '.pdf', outputExt: 'csv', outputMime: 'text/csv' },
  'pdf-to-epub': { title: 'PDF ‚Üí EPUB eBook', icon: 'üìö', accept: '.pdf', outputExt: 'epub', outputMime: 'application/epub+zip' },
  'pdf-to-rtf': { title: 'PDF ‚Üí Rich Text Format', icon: 'üìÉ', accept: '.pdf', outputExt: 'rtf', outputMime: 'application/rtf' },
  'img-to-pdf': { title: 'Image ‚Üí PDF', icon: 'üñºÔ∏è', accept: '.jpg,.jpeg,.png,.webp,.gif,.bmp', outputExt: 'pdf', outputMime: 'application/pdf' },
  'txt-to-pdf': { title: 'Text ‚Üí PDF', icon: 'üìÉ', accept: '.txt', outputExt: 'pdf', outputMime: 'application/pdf' },
  'html-to-pdf': { title: 'HTML ‚Üí PDF', icon: 'üåê', accept: '.html,.htm', outputExt: 'pdf', outputMime: 'application/pdf' },
  'md-to-pdf': { title: 'Markdown ‚Üí PDF', icon: 'üìã', accept: '.md,.markdown', outputExt: 'pdf', outputMime: 'application/pdf' },
  'csv-to-pdf': { title: 'CSV ‚Üí PDF', icon: 'üìä', accept: '.csv', outputExt: 'pdf', outputMime: 'application/pdf' },
  'xlsx-to-pdf': { title: 'Excel ‚Üí PDF', icon: 'üìó', accept: '.xlsx,.xls', outputExt: 'pdf', outputMime: 'application/pdf' },
  'rtf-to-pdf': { title: 'RTF ‚Üí PDF', icon: 'üìÉ', accept: '.rtf', outputExt: 'pdf', outputMime: 'application/pdf' },
  'pdf-merge': { title: 'Merge PDFs', icon: 'üîó', accept: '.pdf', outputExt: 'pdf', outputMime: 'application/pdf' },
  'pdf-split': { title: 'Split PDF', icon: '‚úÇÔ∏è', accept: '.pdf', outputExt: 'zip', outputMime: 'application/zip' },
  'pdf-rotate': { title: 'Rotate PDF Pages', icon: 'üîÑ', accept: '.pdf', outputExt: 'pdf', outputMime: 'application/pdf' },
  'pdf-watermark': { title: 'Add Watermark to PDF', icon: 'üíß', accept: '.pdf', outputExt: 'pdf', outputMime: 'application/pdf' },
  'pdf-compress': { title: 'Compress PDF', icon: 'üóúÔ∏è', accept: '.pdf', outputExt: 'pdf', outputMime: 'application/pdf' },
};

const CONVERSION_OPTIONS = {
  'pdf-to-jpg': `<div class="option-group"><div class="option-label">QUALITY</div><select class="option-select" id="opt-quality"><option value="2">Standard (72 DPI)</option><option value="3" selected>High (150 DPI)</option><option value="4">Ultra (300 DPI)</option></select></div>`,
  'pdf-to-png': `<div class="option-group"><div class="option-label">QUALITY</div><select class="option-select" id="opt-quality"><option value="2">Standard (72 DPI)</option><option value="3" selected>High (150 DPI)</option><option value="4">Ultra (300 DPI)</option></select></div>`,
  'pdf-rotate': `<div class="option-group"><div class="option-label">ROTATION</div><select class="option-select" id="opt-rotate"><option value="90">90¬∞ Clockwise</option><option value="180">180¬∞</option><option value="270">270¬∞ (90¬∞ CCW)</option></select></div>`,
  'pdf-watermark': `<div class="option-group"><div class="option-label">WATERMARK TEXT</div><input type="text" class="option-input" id="opt-watermark" value="CONFIDENTIAL" placeholder="Watermark text..."></div><div class="option-group"><div class="option-label">OPACITY</div><select class="option-select" id="opt-opacity"><option value="0.1">Light (10%)</option><option value="0.2" selected>Medium (20%)</option><option value="0.4">Heavy (40%)</option></select></div>`,
  'pdf-split': `<div class="option-group"><div class="option-label">SPLIT MODE</div><select class="option-select" id="opt-split-mode"><option value="all">Every page separate</option><option value="range">Page range</option></select></div>`,
  'img-to-pdf': `<div class="option-group"><div class="option-label">PAGE SIZE</div><select class="option-select" id="opt-page-size"><option value="a4" selected>A4</option><option value="letter">Letter</option><option value="fit">Fit to Image</option></select></div>`,
  'txt-to-pdf': `<div class="option-group"><div class="option-label">FONT SIZE</div><select class="option-select" id="opt-font-size"><option value="10">Small (10pt)</option><option value="12" selected>Normal (12pt)</option><option value="14">Large (14pt)</option></select></div>`,
  'csv-to-pdf': `<div class="option-group"><div class="option-label">ORIENTATION</div><select class="option-select" id="opt-orient"><option value="landscape" selected>Landscape</option><option value="portrait">Portrait</option></select></div>`,
  'xlsx-to-pdf': `<div class="option-group"><div class="option-label">ORIENTATION</div><select class="option-select" id="opt-orient"><option value="landscape" selected>Landscape</option><option value="portrait">Portrait</option></select></div>`,
};

function selectConversion(el, type) {
  document.querySelectorAll('.conv-card.selected').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  currentConversion = type;

  const meta = CONVERSION_META[type];
  if (!meta) return;

  document.getElementById('panel-icon').textContent = meta.icon;
  document.getElementById('panel-title-text').textContent = meta.title;

  // Options
  const opts = document.getElementById('panel-options');
  opts.innerHTML = CONVERSION_OPTIONS[type] || '';

  document.getElementById('conversion-panel').classList.add('show');
  document.getElementById('progress-wrap').classList.remove('show');
  hideResult();

  // Update file input accept
  document.getElementById('file-input').accept = meta.accept;

  // Scroll to panel
  setTimeout(() => {
    document.getElementById('conversion-panel').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }, 100);
}

// ===== CONVERSION ENGINE =====
async function doConvert() {
  if (!currentFile) {
    // Prompt file selection if no file
    document.getElementById('file-input').click();
    showToast('‚ö†Ô∏è Please select a file first!');
    return;
  }

  if (!currentConversion) {
    showToast('‚ö†Ô∏è Please select a conversion type!');
    return;
  }

  const btn = document.getElementById('btn-convert');
  btn.disabled = true;
  btn.textContent = '‚öôÔ∏è CONVERTING...';

  showProgress(0, 'Starting conversion...');
  hideResult();

  try {
    await runConversion(currentConversion);
  } catch (err) {
    console.error(err);
    showToast('‚ùå Error: ' + err.message);
  }

  btn.disabled = false;
  btn.textContent = '‚ö° CONVERT NOW';
}

function showProgress(pct, text) {
  document.getElementById('progress-wrap').classList.add('show');
  document.getElementById('progress-bar').style.width = pct + '%';
  document.getElementById('progress-text').textContent = text;
}

async function runConversion(type) {
  const file = currentFile;
  const baseName = file.name.replace(/\.[^.]+$/, '');
  const meta = CONVERSION_META[type];

  const handlers = {
    'pdf-to-txt': convPdfToTxt,
    'pdf-to-html': convPdfToHtml,
    'pdf-to-md': convPdfToMd,
    'pdf-to-csv': convPdfToCsv,
    'pdf-to-jpg': convPdfToImages.bind(null, 'jpeg'),
    'pdf-to-png': convPdfToImages.bind(null, 'png'),
    'pdf-to-docx': convPdfToDocx,
    'pdf-to-xlsx': convPdfToXlsx,
    'pdf-to-pptx': convPdfToPptx,
    'pdf-to-epub': convPdfToEpub,
    'pdf-to-rtf': convPdfToRtf,
    'img-to-pdf': convImgToPdf,
    'txt-to-pdf': convTxtToPdf,
    'html-to-pdf': convHtmlToPdf,
    'md-to-pdf': convMdToPdf,
    'csv-to-pdf': convCsvToPdf,
    'xlsx-to-pdf': convXlsxToPdf,
    'rtf-to-pdf': convRtfToPdf,
    'pdf-merge': convPdfMerge,
    'pdf-split': convPdfSplit,
    'pdf-rotate': convPdfRotate,
    'pdf-watermark': convPdfWatermark,
    'pdf-compress': convPdfCompress,
  };

  if (!handlers[type]) {
    throw new Error('Conversion type not yet implemented.');
  }

  const blob = await handlers[type](file, baseName);
  const ext = meta.outputExt;
  resultFilename = baseName + '_converted.' + ext;
  resultBlob = blob;

  showProgress(100, 'Done!');
  setTimeout(() => {
    document.getElementById('progress-wrap').classList.remove('show');
    showResult(`File converted successfully ‚Üí ${resultFilename}`);
  }, 400);
}

// ===== HELPERS =====
async function readFileAsArrayBuffer(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = e => res(e.target.result);
    r.onerror = rej;
    r.readAsArrayBuffer(file);
  });
}

async function readFileAsText(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = e => res(e.target.result);
    r.onerror = rej;
    r.readAsText(file);
  });
}

async function readFileAsDataURL(file) {
  return new Promise((res, rej) => {
    const r = new FileReader();
    r.onload = e => res(e.target.result);
    r.onerror = rej;
    r.readAsDataURL(file);
  });
}

async function loadPdfDoc(file) {
  const ab = await readFileAsArrayBuffer(file);
  const lib = window['pdfjs-dist/build/pdf'];
  if (!lib) throw new Error('PDF.js not loaded. Please check your connection.');
  lib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  return await lib.getDocument({ data: new Uint8Array(ab) }).promise;
}

async function extractPdfText(file) {
  showProgress(10, 'Loading PDF...');
  const pdf = await loadPdfDoc(file);
  const pages = [];
  for (let i = 1; i <= pdf.numPages; i++) {
    showProgress(10 + (i / pdf.numPages) * 60, `Extracting page ${i} of ${pdf.numPages}...`);
    const page = await pdf.getPage(i);
    const textContent = await page.getTextContent();
    const text = textContent.items.map(item => item.str).join(' ');
    pages.push({ num: i, text });
  }
  return { pdf, pages };
}

// ===== CONVERSION FUNCTIONS =====

async function convPdfToTxt(file, base) {
  const { pages } = await extractPdfText(file);
  showProgress(80, 'Building text file...');
  const content = pages.map(p => `--- Page ${p.num} ---\n\n${p.text}`).join('\n\n');
  showProgress(95, 'Finalizing...');
  return new Blob([content], { type: 'text/plain' });
}

async function convPdfToHtml(file, base) {
  const { pages } = await extractPdfText(file);
  showProgress(80, 'Building HTML...');
  const bodyContent = pages.map(p => `
    <section class="page">
      <h2>Page ${p.num}</h2>
      <p>${p.text.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
    </section>`).join('\n');
  const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${base}</title>
  <style>
    body { font-family: Georgia, serif; max-width: 800px; margin: 40px auto; padding: 0 20px; color: #333; line-height: 1.8; }
    h1 { font-size: 28px; border-bottom: 2px solid #333; padding-bottom: 10px; }
    h2 { color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; margin-top: 40px; }
    .page { margin-bottom: 40px; padding-bottom: 40px; border-bottom: 1px solid #eee; }
    p { text-align: justify; }
  </style>
</head>
<body>
  <h1>${base}</h1>
  ${bodyContent}
</body>
</html>`;
  return new Blob([html], { type: 'text/html' });
}

async function convPdfToMd(file, base) {
  const { pages } = await extractPdfText(file);
  showProgress(80, 'Building Markdown...');
  const content = `# ${base}\n\n` +
    pages.map(p => `## Page ${p.num}\n\n${p.text}`).join('\n\n---\n\n');
  return new Blob([content], { type: 'text/markdown' });
}

async function convPdfToCsv(file, base) {
  const { pages } = await extractPdfText(file);
  showProgress(80, 'Building CSV...');
  const rows = [['Page', 'Content']];
  pages.forEach(p => {
    const escaped = p.text.replace(/"/g, '""');
    rows.push([p.num, `"${escaped}"`]);
  });
  const csv = rows.map(r => r.join(',')).join('\n');
  return new Blob([csv], { type: 'text/csv' });
}

async function convPdfToRtf(file, base) {
  const { pages } = await extractPdfText(file);
  showProgress(80, 'Building RTF...');
  const rtfContent = pages.map(p => p.text).join('\n\n\\page\n\n');
  const rtf = `{\\rtf1\\ansi\\deff0
{\\fonttbl{\\f0\\froman\\fcharset0 Times New Roman;}}
\\f0\\fs24
${rtfContent.replace(/[\\{}]/g, c => '\\' + c).replace(/\n/g, '\\par\n')}
}`;
  return new Blob([rtf], { type: 'application/rtf' });
}

async function convPdfToDocx(file, base) {
  const { pages } = await extractPdfText(file);
  showProgress(80, 'Building Word document...');
  // Create a proper .docx (ZIP with XML)
  const zip = new JSZip();
  const allText = pages.map(p => `<w:p><w:pPr><w:jc w:val="center"/></w:pPr><w:r><w:rPr><w:b/><w:sz w:val="28"/></w:rPr><w:t>Page ${p.num}</w:t></w:r></w:p>\n<w:p><w:r><w:t xml:space="preserve">${escapeXml(p.text)}</w:t></w:r></w:p>\n<w:p/>`).join('\n');
  
  const docXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"
  xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<w:body>
<w:p><w:pPr><w:pStyle w:val="Title"/></w:pPr><w:r><w:t>${escapeXml(base)}</w:t></w:r></w:p>
${allText}
<w:sectPr><w:pgSz w:w="12240" w:h="15840"/></w:sectPr>
</w:body>
</w:document>`;

  const relsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

  const wordRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;

  const stylesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:style w:type="paragraph" w:default="1" w:styleId="Normal"><w:name w:val="Normal"/><w:qFormat/></w:style>
  <w:style w:type="paragraph" w:styleId="Title"><w:name w:val="Title"/><w:basedOn w:val="Normal"/><w:qFormat/><w:rPr><w:b/><w:sz w:val="40"/></w:rPr></w:style>
</w:styles>`;

  const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`;

  zip.file('[Content_Types].xml', contentTypes);
  zip.file('_rels/.rels', relsXml);
  zip.file('word/document.xml', docXml);
  zip.file('word/styles.xml', stylesXml);
  zip.file('word/_rels/document.xml.rels', wordRels);

  showProgress(95, 'Packaging document...');
  const blob = await zip.generateAsync({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
  return blob;
}

async function convPdfToXlsx(file, base) {
  const { pages } = await extractPdfText(file);
  showProgress(80, 'Building Excel file...');
  const wb = XLSX.utils.book_new();
  const data = [['Page', 'Content'], ...pages.map(p => [p.num, p.text])];
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = [{ width: 8 }, { width: 80 }];
  XLSX.utils.book_append_sheet(wb, ws, 'Content');
  
  // Summary sheet
  const summaryData = [
    ['PDF Ultra Converter - Excel Export'],
    ['Source File', file.name],
    ['Total Pages', pages.length],
    ['Converted On', new Date().toLocaleString()],
    [],
    ['Page', 'Word Count', 'Character Count'],
    ...pages.map(p => [p.num, p.text.split(/\s+/).filter(Boolean).length, p.text.length])
  ];
  const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
  XLSX.utils.book_append_sheet(wb, ws2, 'Summary');

  const ab = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  return new Blob([ab], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
}

async function convPdfToPptx(file, base) {
  const { pages } = await extractPdfText(file);
  showProgress(80, 'Building PowerPoint...');
  const zip = new JSZip();

  const slideXmls = pages.map((p, idx) => {
    const slideNum = idx + 1;
    const text = p.text.substring(0, 800);
    return `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<p:sld xmlns:p="http://schemas.openxmlformats.org/presentationml/2006/main"
  xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <p:cSld>
    <p:spTree>
      <p:nvGrpSpPr><p:cNvPr id="1" name=""/><p:cNvGrpSpPr/><p:nvPr/></p:nvGrpSpPr>
      <p:grpSpPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="0" cy="0"/></a:xfrm></p:grpSpPr>
      <p:sp>
        <p:nvSpPr><p:cNvPr id="2" name="Title"/><p:cNvSpPr><a:spLocks noGrp="1"/></p:cNvSpPr><p:nvPr><p:ph type="title"/></p:nvPr></p:nvSpPr>
        <p:spPr/>
        <p:txBody><a:bodyPr/><a:lstStyle/><a:p><a:r><a:t>Page ${slideNum}</a:t></a:r></a:p></p:txBody>
      </p:sp>
      <p:sp>
        <p:nvSpPr><p:cNvPr id="3" name="Content"/><p:cNvSpPr><a:spLocks noGrp="1"/></p:cNvSpPr><p:nvPr><p:ph idx="1"/></p:nvPr></p:nvSpPr>
        <p:spPr/>
        <p:txBody><a:bodyPr/><a:lstStyle/><a:p><a:r><a:rPr lang="en-US"/><a:t>${escapeXml(text)}</a:t></a:r></a:p></p:txBody>
      </p:sp>
    </p:spTree>
  </p:cSld>
</p:sld>`;
  });

  const slideRels = pages.map(() => `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideLayout" Target="../slideLayouts/slideLayout1.xml"/>
</Relationships>`);

  const slideIds = pages.map((_, i) => `<p:sldId id="${256 + i}" r:id="rId${i + 2}"/>`).join('\n');
  const slideRelsInPres = pages.map((_, i) => `<Relationship Id="rId${i + 2}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/slide" Target="slides/slide${i + 1}.xml"/>`).join('\n');

  const presXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<p:presentation xmlns:p="http://schemas.openxmlformats.org/presentationml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
  xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main">
  <p:sldMasterIdLst><p:sldMasterId id="2147483648" r:id="rId1"/></p:sldMasterIdLst>
  <p:sldIdLst>${slideIds}</p:sldIdLst>
  <p:sldSz cx="9144000" cy="6858000"/>
  <p:notesSz cx="6858000" cy="9144000"/>
</p:presentation>`;

  const presRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster" Target="slideMasters/slideMaster1.xml"/>
  ${slideRelsInPres}
</Relationships>`;

  const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/ppt/presentation.xml" ContentType="application/vnd.openxmlformats-officedocument.presentationml.presentation.main+xml"/>
  ${pages.map((_, i) => `<Override PartName="/ppt/slides/slide${i+1}.xml" ContentType="application/vnd.openxmlformats-officedocument.presentationml.slide+xml"/>`).join('\n')}
</Types>`;

  const rootRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="ppt/presentation.xml"/>
</Relationships>`;

  // Minimal slide master
  const slideMasterXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<p:sldMaster xmlns:p="http://schemas.openxmlformats.org/presentationml/2006/main"
  xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
  <p:cSld><p:spTree><p:nvGrpSpPr><p:cNvPr id="1" name=""/><p:cNvGrpSpPr/><p:nvPr/></p:nvGrpSpPr><p:grpSpPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="0" cy="0"/></a:xfrm></p:grpSpPr></p:spTree></p:cSld>
  <p:txStyles>
    <p:titleStyle><a:lvl1pPr><a:defRPr b="1" lang="en-US" sz="3600"/></a:lvl1pPr></p:titleStyle>
    <p:bodyStyle><a:lvl1pPr><a:defRPr lang="en-US" sz="2400"/></a:lvl1pPr></p:bodyStyle>
    <p:otherStyle><a:lvl1pPr><a:defRPr lang="en-US"/></a:lvl1pPr></p:otherStyle>
  </p:txStyles>
  <p:sldLayoutIdLst><p:sldLayoutId id="2147483649" r:id="rId1"/></p:sldLayoutIdLst>
</p:sldMaster>`;

  const slideMasterRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideLayout" Target="../slideLayouts/slideLayout1.xml"/>
</Relationships>`;

  const slideLayoutXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<p:sldLayout xmlns:p="http://schemas.openxmlformats.org/presentationml/2006/main"
  xmlns:a="http://schemas.openxmlformats.org/drawingml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" type="tx">
  <p:cSld name="Title and Content">
    <p:spTree>
      <p:nvGrpSpPr><p:cNvPr id="1" name=""/><p:cNvGrpSpPr/><p:nvPr/></p:nvGrpSpPr>
      <p:grpSpPr><a:xfrm><a:off x="0" y="0"/><a:ext cx="0" cy="0"/></a:xfrm></p:grpSpPr>
      <p:sp><p:nvSpPr><p:cNvPr id="2" name="Title"/><p:cNvSpPr><a:spLocks noGrp="1"/></p:cNvSpPr><p:nvPr><p:ph type="title"/></p:nvPr></p:nvSpPr>
        <p:spPr><a:xfrm><a:off x="457200" y="274638"/><a:ext cx="8229600" cy="1143000"/></a:xfrm></p:spPr>
        <p:txBody><a:bodyPr/><a:lstStyle/><a:p><a:r><a:t>Click to edit title</a:t></a:r></a:p></p:txBody>
      </p:sp>
      <p:sp><p:nvSpPr><p:cNvPr id="3" name="Content"/><p:cNvSpPr><a:spLocks noGrp="1"/></p:cNvSpPr><p:nvPr><p:ph idx="1"/></p:nvPr></p:nvSpPr>
        <p:spPr><a:xfrm><a:off x="457200" y="1600200"/><a:ext cx="8229600" cy="4525963"/></a:xfrm></p:spPr>
        <p:txBody><a:bodyPr/><a:lstStyle/><a:p><a:r><a:t>Click to edit content</a:t></a:r></a:p></p:txBody>
      </p:sp>
    </p:spTree>
  </p:cSld>
</p:sldLayout>`;

  const slideLayoutRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideMaster" Target="../slideMasters/slideMaster1.xml"/>
</Relationships>`;

  zip.file('[Content_Types].xml', contentTypes);
  zip.file('_rels/.rels', rootRels);
  zip.file('ppt/presentation.xml', presXml);
  zip.file('ppt/_rels/presentation.xml.rels', presRels);
  zip.file('ppt/slideMasters/slideMaster1.xml', slideMasterXml);
  zip.file('ppt/slideMasters/_rels/slideMaster1.xml.rels', slideMasterRels);
  zip.file('ppt/slideLayouts/slideLayout1.xml', slideLayoutXml);
  zip.file('ppt/slideLayouts/_rels/slideLayout1.xml.rels', slideLayoutRels);

  slideXmls.forEach((xml, i) => {
    zip.file(`ppt/slides/slide${i+1}.xml`, xml);
    zip.file(`ppt/slides/_rels/slide${i+1}.xml.rels`, slideRels[i]);
  });

  showProgress(95, 'Packaging presentation...');
  return await zip.generateAsync({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.presentationml.presentation' });
}

async function convPdfToEpub(file, base) {
  const { pages } = await extractPdfText(file);
  showProgress(80, 'Building ePub...');
  const zip = new JSZip();

  zip.file('mimetype', 'application/epub+zip', { compression: 'STORE' });

  const containerXml = `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`;
  zip.file('META-INF/container.xml', containerXml);

  const chaptersHtml = pages.map((p, i) => {
    const html = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head><title>Page ${p.num}</title></head>
<body>
  <h2>Page ${p.num}</h2>
  <p>${escapeXml(p.text)}</p>
</body>
</html>`;
    zip.file(`OEBPS/chapter${i+1}.xhtml`, html);
    return { id: `chapter${i+1}`, href: `chapter${i+1}.xhtml`, title: `Page ${p.num}` };
  });

  const manifest = chaptersHtml.map(c => `<item id="${c.id}" href="${c.href}" media-type="application/xhtml+xml"/>`).join('\n');
  const spine = chaptersHtml.map(c => `<itemref idref="${c.id}"/>`).join('\n');
  const ncx = chaptersHtml.map((c, i) => `<navPoint id="np${i+1}" playOrder="${i+1}"><navLabel><text>${c.title}</text></navLabel><content src="${c.href}"/></navPoint>`).join('\n');

  const opf = `<?xml version="1.0" encoding="UTF-8"?>
<package xmlns="http://www.idpf.org/2007/opf" version="2.0" unique-identifier="book-id">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:title>${escapeXml(base)}</dc:title>
    <dc:language>en</dc:language>
    <dc:identifier id="book-id">urn:uuid:${crypto.randomUUID ? crypto.randomUUID() : Date.now()}</dc:identifier>
  </metadata>
  <manifest>
    <item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>
    ${manifest}
  </manifest>
  <spine toc="ncx">${spine}</spine>
</package>`;

  const tocNcx = `<?xml version="1.0" encoding="UTF-8"?>
<ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1">
  <head><meta name="dtb:uid" content="book-id"/></head>
  <docTitle><text>${escapeXml(base)}</text></docTitle>
  <navMap>${ncx}</navMap>
</ncx>`;

  zip.file('OEBPS/content.opf', opf);
  zip.file('OEBPS/toc.ncx', tocNcx);

  return await zip.generateAsync({ type: 'blob', mimeType: 'application/epub+zip' });
}

async function convPdfToImages(format, file, base) {
  showProgress(10, 'Loading PDF...');
  const pdf = await loadPdfDoc(file);
  const quality = parseFloat(document.getElementById('opt-quality')?.value || '3');
  const zip = new JSZip();

  for (let i = 1; i <= pdf.numPages; i++) {
    showProgress(10 + (i / pdf.numPages) * 80, `Rendering page ${i} of ${pdf.numPages}...`);
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: quality });
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    const ctx = canvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport }).promise;
    const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png';
    const ext = format === 'jpeg' ? 'jpg' : 'png';
    const dataUrl = canvas.toDataURL(mimeType, 0.92);
    const base64Data = dataUrl.split(',')[1];
    zip.file(`${base}_page${String(i).padStart(3, '0')}.${ext}`, base64Data, { base64: true });
  }

  showProgress(95, 'Compressing images...');
  return await zip.generateAsync({ type: 'blob' });
}

// ===== TO PDF CONVERTERS =====

async function convImgToPdf(file, base) {
  showProgress(20, 'Loading image...');
  const dataUrl = await readFileAsDataURL(file);
  const pageSize = document.getElementById('opt-page-size')?.value || 'a4';
  const { jsPDF } = window.jspdf;
  if (!jsPDF) throw new Error('jsPDF not loaded');
  
  const img = new Image();
  await new Promise(res => { img.onload = res; img.src = dataUrl; });
  
  showProgress(50, 'Creating PDF...');
  
  let w, h;
  if (pageSize === 'a4') { w = 210; h = 297; }
  else if (pageSize === 'letter') { w = 215.9; h = 279.4; }
  else { w = img.width * 0.264583; h = img.height * 0.264583; }
  
  const orient = img.width > img.height ? 'landscape' : 'portrait';
  const doc = new jsPDF({ orientation: orient, unit: 'mm', format: pageSize === 'fit' ? [w, h] : pageSize });
  
  const pw = doc.internal.pageSize.getWidth();
  const ph = doc.internal.pageSize.getHeight();
  const ratio = Math.min(pw / img.width, ph / img.height);
  const iw = img.width * ratio;
  const ih = img.height * ratio;
  const x = (pw - iw) / 2;
  const y = (ph - ih) / 2;
  
  doc.addImage(dataUrl, 'JPEG', x, y, iw, ih);
  showProgress(90, 'Finalizing...');
  return doc.output('blob');
}

async function convTxtToPdf(file, base) {
  showProgress(20, 'Reading text...');
  const text = await readFileAsText(file);
  const fontSize = parseInt(document.getElementById('opt-font-size')?.value || '12');
  const { jsPDF } = window.jspdf;
  if (!jsPDF) throw new Error('jsPDF not loaded');
  
  showProgress(50, 'Creating PDF...');
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });
  doc.setFontSize(fontSize);
  doc.setFont('helvetica', 'normal');
  
  const lines = doc.splitTextToSize(text, 180);
  const lh = fontSize * 0.3528 * 1.5;
  let y = 20;
  
  for (const line of lines) {
    if (y > 280) { doc.addPage(); y = 20; }
    doc.text(line, 15, y);
    y += lh;
  }
  
  showProgress(90, 'Finalizing...');
  return doc.output('blob');
}

async function convHtmlToPdf(file, base) {
  showProgress(20, 'Reading HTML...');
  const html = await readFileAsText(file);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });
  
  // Strip HTML tags and convert to text
  const tmp = document.createElement('div');
  tmp.innerHTML = html;
  const text = tmp.textContent || tmp.innerText;
  
  showProgress(60, 'Creating PDF...');
  doc.setFontSize(11);
  const lines = doc.splitTextToSize(text, 180);
  const lh = 5;
  let y = 20;
  for (const line of lines) {
    if (y > 280) { doc.addPage(); y = 20; }
    doc.text(line, 15, y);
    y += lh;
  }
  
  return doc.output('blob');
}

async function convMdToPdf(file, base) {
  const text = await readFileAsText(file);
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });
  
  showProgress(50, 'Creating PDF...');
  const lines = text.split('\n');
  let y = 20;
  
  for (const line of lines) {
    if (y > 275) { doc.addPage(); y = 20; }
    if (line.startsWith('# ')) {
      doc.setFontSize(20); doc.setFont('helvetica', 'bold');
      doc.text(line.substring(2), 15, y); y += 10;
    } else if (line.startsWith('## ')) {
      doc.setFontSize(16); doc.setFont('helvetica', 'bold');
      doc.text(line.substring(3), 15, y); y += 8;
    } else if (line.startsWith('### ')) {
      doc.setFontSize(13); doc.setFont('helvetica', 'bold');
      doc.text(line.substring(4), 15, y); y += 7;
    } else if (line.trim() === '---' || line.trim() === '***') {
      doc.setDrawColor(150); doc.line(15, y, 195, y); y += 5;
    } else {
      doc.setFontSize(11); doc.setFont('helvetica', 'normal');
      const wrapped = doc.splitTextToSize(line || ' ', 180);
      for (const wl of wrapped) {
        if (y > 275) { doc.addPage(); y = 20; }
        doc.text(wl, 15, y); y += 5;
      }
    }
  }
  
  return doc.output('blob');
}

async function convCsvToPdf(file, base) {
  showProgress(20, 'Reading CSV...');
  const text = await readFileAsText(file);
  const wb = XLSX.read(text, { type: 'string' });
  const ws = wb.Sheets[wb.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
  
  const orient = document.getElementById('opt-orient')?.value || 'landscape';
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: orient, unit: 'mm', format: 'a4' });
  
  showProgress(60, 'Building table...');
  await buildTablePdf(doc, data);
  return doc.output('blob');
}

async function convXlsxToPdf(file, base) {
  showProgress(20, 'Reading Excel...');
  const ab = await readFileAsArrayBuffer(file);
  const wb = XLSX.read(ab, { type: 'array' });
  const ws = wb.Sheets[wb.SheetNames[0]];
  const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
  
  const orient = document.getElementById('opt-orient')?.value || 'landscape';
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: orient, unit: 'mm', format: 'a4' });
  
  showProgress(60, 'Building table...');
  await buildTablePdf(doc, data);
  return doc.output('blob');
}

async function buildTablePdf(doc, data) {
  if (!data || data.length === 0) return;
  const pw = doc.internal.pageSize.getWidth();
  const numCols = Math.max(...data.map(r => (r || []).length));
  const colW = Math.min(40, (pw - 20) / Math.max(numCols, 1));
  
  let y = 20;
  data.forEach((row, ri) => {
    if (y > doc.internal.pageSize.getHeight() - 15) { doc.addPage(); y = 20; }
    if (ri === 0) {
      doc.setFillColor(30, 30, 50);
      doc.setTextColor(0, 212, 255);
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
    } else {
      doc.setFillColor(ri % 2 === 0 ? 245 : 255, 245, 250);
      doc.setTextColor(50, 50, 70);
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
    }
    for (let ci = 0; ci < numCols; ci++) {
      const x = 10 + ci * colW;
      doc.rect(x, y - 5, colW, 7, 'F');
      const val = String((row || [])[ci] || '');
      doc.text(val.substring(0, Math.floor(colW / 2.2)), x + 1, y);
    }
    y += 7;
  });
  doc.setTextColor(0, 0, 0);
}

async function convRtfToPdf(file, base) {
  const text = await readFileAsText(file);
  const stripped = text.replace(/\{[^{}]*\}|\\[a-z]+\s*|\\/g, ' ').trim();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'mm', format: 'a4' });
  doc.setFontSize(12);
  const lines = doc.splitTextToSize(stripped, 180);
  let y = 20;
  for (const line of lines) {
    if (y > 280) { doc.addPage(); y = 20; }
    doc.text(line, 15, y); y += 6;
  }
  return doc.output('blob');
}

// ===== PDF TOOLS =====
async function convPdfMerge(file, base) {
  // For merge we use the current single file (demo - shows how it works)
  const ab = await readFileAsArrayBuffer(file);
  const { PDFDocument } = PDFLib;
  const srcDoc = await PDFDocument.load(ab);
  const merged = await PDFDocument.create();
  const copiedPages = await merged.copyPages(srcDoc, srcDoc.getPageIndices());
  copiedPages.forEach(p => merged.addPage(p));
  const bytes = await merged.save();
  return new Blob([bytes], { type: 'application/pdf' });
}

async function convPdfSplit(file, base) {
  showProgress(10, 'Loading PDF...');
  const ab = await readFileAsArrayBuffer(file);
  const { PDFDocument } = PDFLib;
  const srcDoc = await PDFDocument.load(ab);
  const numPages = srcDoc.getPageCount();
  const zip = new JSZip();

  for (let i = 0; i < numPages; i++) {
    showProgress(10 + (i / numPages) * 80, `Extracting page ${i+1} of ${numPages}...`);
    const newDoc = await PDFDocument.create();
    const [copiedPage] = await newDoc.copyPages(srcDoc, [i]);
    newDoc.addPage(copiedPage);
    const bytes = await newDoc.save();
    zip.file(`${base}_page${String(i+1).padStart(3,'0')}.pdf`, bytes);
  }

  showProgress(95, 'Compressing...');
  return await zip.generateAsync({ type: 'blob' });
}

async function convPdfRotate(file, base) {
  const ab = await readFileAsArrayBuffer(file);
  const { PDFDocument, degrees } = PDFLib;
  const srcDoc = await PDFDocument.load(ab);
  const rotateAngle = parseInt(document.getElementById('opt-rotate')?.value || '90');
  
  showProgress(50, 'Rotating pages...');
  const pages = srcDoc.getPages();
  pages.forEach(page => {
    const currentRotation = page.getRotation().angle;
    page.setRotation(degrees(currentRotation + rotateAngle));
  });
  
  showProgress(90, 'Saving...');
  const bytes = await srcDoc.save();
  return new Blob([bytes], { type: 'application/pdf' });
}

async function convPdfWatermark(file, base) {
  const ab = await readFileAsArrayBuffer(file);
  const { PDFDocument, rgb, StandardFonts, degrees } = PDFLib;
  const srcDoc = await PDFDocument.load(ab);
  const watermarkText = document.getElementById('opt-watermark')?.value || 'CONFIDENTIAL';
  const opacity = parseFloat(document.getElementById('opt-opacity')?.value || '0.2');

  showProgress(40, 'Adding watermark...');
  const font = await srcDoc.embedFont(StandardFonts.HelveticaBold);
  const pages = srcDoc.getPages();

  pages.forEach(page => {
    const { width, height } = page.getSize();
    const fontSize = Math.min(width, height) * 0.1;
    const textWidth = font.widthOfTextAtSize(watermarkText, fontSize);
    page.drawText(watermarkText, {
      x: (width - textWidth) / 2,
      y: height / 2 - fontSize / 2,
      size: fontSize,
      font,
      color: rgb(0.5, 0.5, 0.5),
      opacity,
      rotate: degrees(45),
    });
  });

  showProgress(90, 'Saving...');
  const bytes = await srcDoc.save();
  return new Blob([bytes], { type: 'application/pdf' });
}

async function convPdfCompress(file, base) {
  showProgress(30, 'Loading PDF...');
  const ab = await readFileAsArrayBuffer(file);
  const { PDFDocument } = PDFLib;
  const srcDoc = await PDFDocument.load(ab, { updateMetadata: false });
  showProgress(70, 'Optimizing...');
  const bytes = await srcDoc.save({ useObjectStreams: true });
  showProgress(90, 'Done!');
  return new Blob([bytes], { type: 'application/pdf' });
}

// ===== RESULT & DOWNLOAD =====
function showResult(msg) {
  document.getElementById('result-sub').textContent = msg;
  document.getElementById('result-area').classList.add('show');
  document.getElementById('result-area').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function hideResult() {
  document.getElementById('result-area').classList.remove('show');
  resultBlob = null;
}

function triggerDownload() {
  if (!resultBlob || !resultFilename) return;
  saveAs(resultBlob, resultFilename);
  showToast('‚¨á Downloading: ' + resultFilename);
}

function resetAll() {
  clearFile();
  hideResult();
  currentConversion = null;
  document.querySelectorAll('.conv-card.selected').forEach(c => c.classList.remove('selected'));
  document.getElementById('conversion-panel').classList.remove('show');
}

// ===== UTILS =====
function escapeXml(str) {
  return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&apos;');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}
</script>
</body>
</html>
